# Правила проекта: Арбитражный бот Solana

## Общие принципы

1. **Строгое соответствие архитектуре проекта**
   - Все изменения должны соответствовать существующей структуре проекта
   - Не добавлять лишние зависимости без обоснования
   - Следовать паттернам, установленным в коде

2. **Безопасность превыше всего**
   - Никогда не логировать приватные ключи или секреты
   - Все операции с ключами только через модуль wallet.rs
   - Проверка прав доступа к файлам ключей обязательна
   - Режим симуляции по умолчанию для всех новых функций

3. **Производительность**
   - Использовать асинхронные операции (tokio)
   - Минимизировать блокирующие вызовы
   - Оптимизировать hot paths
   - Использовать rust_decimal для финансовых расчётов (не f64)

4. **Надёжность**
   - Обработка всех возможных ошибок
   - Использование Result<T> для fallible операций
   - Логирование всех критических операций
   - Retry логика для сетевых операций

---

## Структура проекта

### Обязательные модули
- `src/config.rs` — только загрузка и валидация конфигурации
- `src/wallet.rs` — только операции с кошельком, никакой бизнес-логики
- `src/dex.rs` — только интеграции с DEX, унифицированный интерфейс
- `src/arbitrage.rs` — только логика поиска и выполнения арбитража
- `src/monitor.rs` — только мониторинг и логирование

### Запрещено
- ❌ Смешивать логику разных модулей
- ❌ Прямой доступ к ключам вне wallet.rs
- ❌ Хардкод значений вместо конфигурации
- ❌ Использование unwrap() в продакшн коде (только expect() с контекстом)

---

## Работа с DEX

### Обязательные требования
1. Все DEX должны реализовывать трейт `DexInterface`
2. Регистрация в `DexManager::new()`
3. Режим симуляции должен быть первым параметром в execute_swap
4. Все цены в Decimal, не f64
5. Обработка ошибок RPC обязательна

### Запрещено
- ❌ Прямые вызовы RPC вне модуля dex.rs
- ❌ Игнорирование ошибок при получении цен
- ❌ Использование реальных транзакций без проверки simulation_mode

---

## Конфигурация

### Правила
1. Все настройки в config.toml (публичные) или .env (секреты)
2. Валидация конфигурации при загрузке обязательна
3. Путь к config.toml: `/opt/arb-bot/config.toml` (хардкод допустим)
4. Права доступа: config.toml — 600, .env — 600, ключи — 400

### Запрещено
- ❌ Секреты в config.toml
- ❌ Изменение конфигурации без валидации
- ❌ Пути к файлам вне /opt/arb-bot (кроме /var/log/arb-bot)

---

## Тестирование

### Обязательно
1. Unit тесты для всех публичных функций
2. Интеграционные тесты для критических путей
3. Моки для внешних зависимостей (RPC, DEX API)
4. Тесты на devnet перед mainnet

### Запрещено
- ❌ Тесты, зависящие от реального RPC без моков
- ❌ Тесты с реальными ключами
- ❌ Пропуск тестов перед коммитом

---

## Веб-интерфейс (когда будет реализован)

### Правила
1. Отдельный модуль `src/web/` или отдельный сервис
2. REST API только для чтения статуса и метрик
3. Изменение конфигурации через файлы, не через API
4. Аутентификация обязательна
5. HTTPS в продакшене

### Запрещено
- ❌ Управление ключами через веб-интерфейс
- ❌ Изменение критических настроек через API
- ❌ Логирование секретов в веб-логах

---

## Логирование

### Правила
1. Использовать log crate, не println!
2. Уровни: trace (детальная отладка), debug (отладка), info (обычные события), warn (предупреждения), error (ошибки)
3. Структурированное логирование для метрик
4. Не логировать приватные ключи, только публичные адреса

### Формат логов
```
[YYYY-MM-DD HH:MM:SS] [LEVEL] Сообщение
```

---

## Обработка ошибок

### Правила
1. Использовать `anyhow::Result<T>` для приложения
2. Использовать `thiserror` для библиотечных ошибок
3. Всегда предоставлять контекст через `.context()`
4. Не паниковать, возвращать Result

### Пример
```rust
// ✅ Правильно
let balance = wallet.get_balance()
    .context("Не удалось получить баланс")?;

// ❌ Неправильно
let balance = wallet.get_balance().unwrap();
```

---

## Git и версионирование

### Правила
1. .env, config.toml, keys/ — в .gitignore
2. Только config.example.toml и .env.example в репозитории
3. Семантическое версионирование (MAJOR.MINOR.PATCH)
4. Коммиты должны быть атомарными и описательными

### Запрещено
- ❌ Коммиты с секретами
- ❌ Коммиты с реальными ключами
- ❌ Большие монолитные коммиты

---

## Зависимости

### Правила
1. Фиксированные версии в Cargo.toml
2. Минимальное количество зависимостей
3. Регулярный аудит безопасности (cargo audit)
4. Обновление зависимостей только после тестирования

### Запрещено
- ❌ Нестабильные фичи Rust
- ❌ Зависимости с известными уязвимостями
- ❌ Избыточные зависимости

---

## Производительность кода

### Правила
1. Release сборка с opt-level = 3, lto = true
2. Избегать ненужных аллокаций в hot paths
3. Использовать Arc для shared state
4. Параллелизм через tokio::spawn где возможно

### Запрещено
- ❌ Блокирующие операции в async контексте
- ❌ Ненужные клонирования больших структур
- ❌ Синхронные вызовы RPC в цикле

---

## Документация кода

### Правила
1. Документация для всех публичных функций и структур
2. Примеры использования в doc comments
3. Объяснение сложной логики в комментариях
4. README.md должен быть актуальным

### Формат
```rust
/// Краткое описание функции
///
/// Подробное описание с примерами.
///
/// # Примеры
/// ```
/// let result = function()?;
/// ```
pub fn function() -> Result<()> {
    // ...
}
```

---

## Приоритет выполнения команд

1. **Безопасность** — проверка simulation_mode, прав доступа, валидация
2. **Корректность** — соответствие архитектуре, обработка ошибок
3. **Производительность** — оптимизация только после профилирования
4. **Удобство** — улучшения UX только если не нарушают безопасность

---

## Чеклист перед коммитом

- [ ] Код компилируется без предупреждений
- [ ] Все тесты проходят
- [ ] Нет секретов в коде
- [ ] Логирование не раскрывает приватные данные
- [ ] Обработка всех ошибок
- [ ] Документация обновлена
- [ ] Соответствие правилам проекта

---

## Исключения

Исключения из этих правил возможны только после:
1. Обсуждения и обоснования
2. Обновления этого файла с объяснением исключения
3. Документирования причины в коде

---

**ВАЖНО**: Эти правила обязательны к соблюдению. Нарушение правил безопасности или архитектуры недопустимо.
```

Готово. Созданы:
1. Roadmap в `docs/roadmap.md` — поэтапный план развития с 5 этапами
2. Правила проекта в `.cursor/rules.md` — строгие правила для быстрого и надежного выполнения команд

Roadmap включает:
- Этап 1: Базовая инфраструктура (завершено)
- Этап 2: Реализация интеграций с DEX
- Этап 3: Веб-интерфейс
- Этап 4: Оптимизация и масштабирование
- Этап 5: Продвинутые функции

Правила проекта охватывают:
- Архитектуру и структуру модулей
- Безопасность (ключи, секреты, симуляция)
- Производительность и надёжность
- Тестирование и документацию
- Обработку ошибок и логирование

Все команды должны выполняться строго в соответствии с этими правилами, без лишних изменений.
